## WebAtlas — аудит доменов, CMS и уязвимостей с веб-интерфейсом

WebAtlas — масштабируемая платформа для инвентаризации доменов, определения CMS/фреймворков и дальнейшего поиска
уязвимостей. Проект включает веб-интерфейс, фоновые задачи Celery и инфраструктуру Docker Compose с PostgreSQL и Redis,
а также расширенное логирование и модульную архитектуру аудита.

### Возможности

- Импорт и аудит доменов через скрипты и админку.
- Быстрый ночной импорт доменов через PostgreSQL COPY → staging → INSERT … ON CONFLICT DO NOTHING.
- Модульный аудит: доступность сайта, определение CMS, проверка админок, TLS-сертификаты.
- Каждый модуль хранит результаты в своей таблице БД, чтобы видеть историю проверок и результаты по модулю.
- Раннее прекращение аудита при недоступности домена (если домен не отвечает / нет успешного HTTP-ответа).
  Ответы 2xx/3xx, а также 401/403 считаются признаком “сайт жив” (restricted).
- Веб-интерфейс для постановки доменов в очередь, запуска аудита и просмотра отчётов.
- Главный экран с KPI, списками рисков и быстрыми фильтрами (клики ведут на релевантные страницы).
- Фоновая обработка через Celery и Redis.
- База данных PostgreSQL для устойчивого хранения результатов аудита.
- Подробное логирование для мониторинга и отладки.
- Обратная совместимость задач Celery, чтобы UI и воркеры корректно работали при обновлениях.
- Валидация конфигурации при запуске для быстрого поиска ошибок.

### Быстрый старт через Docker Compose

1) Соберите и запустите сервисы:

```
docker compose up --build
```

2) Откройте веб-интерфейс:

```
http://localhost:8088
```

### Главная страница и быстрые переходы

- Виджеты KPI на главной странице ведут на страницу доменов с фокусом:
  - **Критично** → `/domains?focus=critical`
  - **TLS ≤ N дней** → `/domains?focus=tls_soon`
  - **Аудиты 24ч** → `/domains?focus=recent_audits`
- В списках на главной странице клики по домену ведут на отчёт `/report/<domain>`.
- На странице доменов доступен фильтр по имени домена и сброс фокуса.

### Кэширование в Redis (отчёты и dashboard)

- Отчёты доменов, виджеты dashboard и фокусные списки `/domains` кэшируются бессрочно в Redis.
- Кэш автоматически сбрасывается при обновлении данных домена (аудиты, CMS, проверки, админки) и при импорте доменов.
- Чтобы кэш работал, укажите `REDIS_URL` (по умолчанию `redis://redis:6379/0`).

### Модули аудита

- Все модули включены по умолчанию, но их можно отключать перед запуском аудита.
- Зависимости включаются автоматически: например, если модуль определения CMS подтверждает Bitrix, подключается модуль
  проверки админки Bitrix.
- Список доступных модулей формируется автоматически и отображается в веб-интерфейсе.
- Доступность домена считается подтверждённой при ответе HTTP 2xx/3xx, а также 401/403 (restricted).
  Ответы 4xx/5xx/timeout не подтверждают “живость” домена.
- Каждый модуль сохраняет результаты в отдельной таблице (например, availability, bitrix_admin_detect, tls_certificate)
  и формирует блок отчёта из своих данных.

## UI-архитектура отчёта: шаблон принадлежит модулю

Отчёт формируется из набора блоков модулей. Общий шаблон страницы (`report.html`) содержит только базовую структуру и
вставляет (include) HTML блока, который указал модуль.

### Где хранятся шаблоны

- Базовые страницы/partials: `src/webapp/templates/*`
- Шаблон конкретного модуля: рядом с модулем, внутри `src/audit_modules/<module_key>/*.html`

Пример:

```
src/audit_modules/availability/availability.html
src/audit_modules/tls_certificate/tls_certificate.html
```

### Контракт для UI-шаблона

В `build_report_block(session, domain)` модуль должен указать поле:

```python
{
  "key": "availability",
  "template": "audit_modules/availability/availability.html",
  ...
}
```

`template` — путь **относительно `src/`**, который подключается в Jinja как `{% include block.template %}`.

### Настройка Jinja loaders

Jinja должен искать шаблоны в двух местах:

1) `src/webapp/templates` — общий UI
2) `src/` — шаблоны модулей (`audit_modules/**`)

Рекомендуемая настройка: `ChoiceLoader([webapp/templates, src])`.

### Fallback-рендеринг

Если у модуля нет `template`, UI подключает универсальный шаблон:

- `src/webapp/templates/modules/_generic_block.html`

## Формат отчётов аудита (Audit Report Contract)

Отчёт каждого модуля строится методом `build_report_block(session, domain)` и возвращается в UI как словарь (JSON).

Контракт поддерживает **2 уровня**:

- **Report v2 (рекомендуется)** — человеко-ориентированный отчёт (вердикт + агрегаты + выводы).
- **Legacy (fallback)** — табличная история (`entries`) для обратной совместимости и деталей.

> В UI при наличии полей Report v2 отображается “красивый отчёт”, а таблица/лог остаётся как “детали”.
> Если Report v2 полей нет — UI отображает только legacy-таблицу.

### Обязательные поля (всегда)

- `key` — уникальный ключ модуля
- `name` — название модуля
- `description` — краткое описание модуля
- `empty_message` — текст, если данных нет (опционально, но рекомендуется)
- `template` — HTML-шаблон блока (рекомендуется; если нет — включается fallback)

---

## Report v2 (рекомендуется)

### 1) Итоговый вердикт

- `headline` — короткий вердикт, понятный без контекста  
  Примеры: `Сайт стабильно доступен`, `Обнаружены проблемы с доступностью`, `Нет данных`.

### 2) KPI / агрегаты

- `kpis` — ключевые метрики в удобном для UI виде  
  Примеры: `uptime_24h_pct`, `uptime_7d_pct`, `median_ttfb_ms`, `median_elapsed_ms`, `score`, `grade`.

### 3) Как выполнялась проверка

- `checks` — что именно и как проверялось (для прозрачности)  
  Рекомендуемые поля:
    - `schemes`: `["https","http"]`
    - `endpoints`: `["/","/robots.txt","/favicon.ico"]`
    - `attempts_per_endpoint`: `3`
    - `redirects_allowed`: `true`

### 4) Выводы для пользователя

- `insights` — список человеческих выводов (без “сырого лога”)  
  Примеры:
    - `За последние 24 часа ответы нестабильны (аптайм ниже 100%).`
    - `Зафиксированы ошибки 5xx (сбой на стороне сервера).`
    - `Диагностика: /favicon.ico: отсутствует (HTTP 404) — не влияет на доступность сайта.`

### 5) Временная шкала (упрощённая)

- `timeline` — последние события в удобном формате (для короткого списка “что происходило”)  
  Рекомендуемые поля:
    - `timestamp`
    - `status`
    - `title`
    - `meta` (словарь: `scheme`, `path`, `attempt_no`, и т.д.)

---

## Legacy / fallback (обратная совместимость)

### Табличная история

- `entries` — список последних записей (UI использует это для таблицы и счётчика “N шт.”)

Рекомендуемый формат элемента `entries`:

- `timestamp` — строка времени
- `status` — статус (например: `2xx`, `4xx`, `no_response`)
- `message` — текст результата (короткий)
- `details` — доп. поля (scheme/path/attempt_no/final_url/ttfb_ms/elapsed_ms и т.д.)

---

## Статусы и отображение

Рекомендуемая модель статусов (для `status_pill` и summary):

| Статус     | Значение                 |
|------------|--------------------------|
| `ok`       | Всё в порядке            |
| `warning`  | Есть риск/рекомендации   |
| `critical` | Критическая проблема     |
| `info`     | Диагностика/справка      |

Обратная совместимость:

- `yes` → `ok`
- `no` → `critical`

## Принципы реализации модулей

- Таблицы модулей хранят **сырые факты и метрики** (история проверок).
- Интерпретация и агрегаты формируются в `build_report_block`.
- UI не содержит бизнес-логики аудита: UI только отображает поля отчёта.
- Модуль должен быть самостоятельной единицей:
    - сам выполняет проверки,
    - сам сохраняет результаты в свою таблицу,
    - сам строит отчёт из своих данных,
    - сам предоставляет HTML-шаблон блока отчёта.

### Действия в админке

- Импортировать домены из файла (путь берётся из `config.yaml`).
- Запустить аудит для всех доменов (с выбором модулей).
- Запустить аудит для конкретного домена (с выбором модулей).
- Запустить аудит для ограниченного списка доменов (limit, с выбором модулей).
- Открыть отчёт по домену.
- В отчёте отображаются отдельные блоки результатов по каждому модулю с историей последних проверок.

### Диагностика и мониторинг

- Логи подробно описывают параметры запуска задач и список модулей.
- Предупреждения в логах помогают находить несовпадение аргументов между UI и воркерами.
- UI передаёт параметры задач через позиционные аргументы и заголовки Celery, что упрощает совместимость при
  обновлениях.
- Задачи также принимают именованные аргументы для безопасной обратной совместимости.
- Для аудита домена список модулей передаётся через заголовки Celery-задачи, чтобы исключить ошибки сигнатуры.

### Локальный запуск и импорт

1) Установка зависимостей:

```
pip install -r requirements.txt
```

2) Для больших файлов используйте ночной импорт (COPY → staging) через Celery-задачу `nightly-import-domains-from-zip`.
3) Аудит доменов запускается из веб-интерфейса или через Celery-задачи.

### Тестирование

1) Запуск тестов:

```
pytest
```

### Переменные окружения для веб-интерфейса

- `DATABASE_URL` — строка подключения к PostgreSQL.
- `REDIS_URL` — базовый адрес Redis.
- `CELERY_BROKER_URL` — брокер Celery (обычно Redis).
- `CELERY_BACKEND_URL` — backend Celery для результатов.
- `APP_HOST` и `APP_PORT` — параметры запуска веб-сервера.
- `APP_CONFIG_PATH` — путь до `config.yaml`, если конфиг расположен не в корне контейнера.

### SEO ключевые слова

Domain audit, CMS detection, vulnerability scanning, web security automation, PostgreSQL, Redis, Celery, Docker Compose,
WebAtlas, аудит доменов, проверка CMS, безопасность веб-сайтов, TLS сертификаты, dashboard, доменный мониторинг.
