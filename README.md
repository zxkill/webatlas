## WebAtlas — аудит доменов, CMS и уязвимостей с веб-интерфейсом
WebAtlas — масштабируемая платформа для инвентаризации доменов, определения CMS/фреймворков и будущего поиска уязвимостей. Проект включает веб-интерфейс, фоновые задачи Celery и инфраструктуру Docker Compose с PostgreSQL и Redis, а также расширенное логирование и модульную архитектуру аудита.

### Возможности
- Импорт и аудит доменов через скрипты и админку.
- Быстрый ночной импорт доменов через PostgreSQL COPY → staging → INSERT … ON CONFLICT DO NOTHING.
- Модульный аудит: доступность сайта, определение CMS, проверка админок, TLS-сертификаты.
- Каждый запуск модуля фиксируется отдельной записью в БД, что позволяет видеть историю проверок.
- Раннее прекращение аудита при недоступности домена (если нет ответа 200 по HTTP/HTTPS).
- Веб-интерфейс для постановки доменов в очередь, запуска аудита и просмотра отчётов.
- Фоновая обработка через Celery и Redis.
- База данных PostgreSQL для устойчивого хранения результатов аудита.
- Подробное логирование для мониторинга и отладки.
- Обратная совместимость задач Celery, чтобы UI и воркеры корректно работали при обновлениях.
- Валидация конфигурации при запуске для быстрого поиска ошибок.

### Быстрый старт через Docker Compose
1) Соберите и запустите сервисы:
```
docker compose up --build
```
2) Откройте веб-интерфейс на нестандартном порту:
```
http://localhost:8088
```

### Модули аудита
- Все модули включены по умолчанию, но их можно отключать перед запуском аудита.
- Зависимости включаются автоматически: например, если модуль определения CMS подтверждает Bitrix, подключается модуль проверки админки Bitrix.
- Список доступных модулей формируется автоматически и отображается в веб-интерфейсе.
- Доступность домена считается подтверждённой только при ответе HTTP 200 по HTTP или HTTPS; при отсутствии 200 остальные проверки пропускаются.
- Для каждого модуля создаётся запись в таблице `module_runs`, чтобы отчёт домена отображал блоки по всем модулям.

### Действия в админке
- Импортировать домены из файла (путь берётся из `config.yaml`).
- Запустить аудит для всех доменов (с выбором модулей).
- Запустить аудит для конкретного домена (с выбором модулей).
- Запустить аудит для ограниченного списка доменов (limit, с выбором модулей).
- Открыть отчёт по домену.
- В отчёте отображаются отдельные блоки результатов по модулям, включая статус и длительность проверки.

### Диагностика и мониторинг
- Логи подробно описывают параметры запуска задач и список модулей.
- Предупреждения в логах помогают находить несовпадение аргументов между UI и воркерами.
- UI передаёт параметры задач через позиционные аргументы и заголовки Celery, что упрощает совместимость при обновлениях.
- Задачи также принимают именованные аргументы для безопасной обратной совместимости.
- Для аудита домена список модулей передаётся через заголовки Celery-задачи, чтобы исключить ошибки сигнатуры.

### Локальный запуск и импорт
1) Установка зависимостей:
```
pip install -r requirements.txt
```
2) Для больших файлов используйте ночной импорт (COPY → staging) через Celery-задачу `nightly-import-domains-from-zip`.
3) Аудит доменов запускается из веб-интерфейса или через Celery-задачи.

### Тестирование
1) Запуск тестов:
```
pytest
```

### Переменные окружения для веб-интерфейса
- `DATABASE_URL` — строка подключения к PostgreSQL.
- `REDIS_URL` — базовый адрес Redis.
- `CELERY_BROKER_URL` — брокер Celery (обычно Redis).
- `CELERY_BACKEND_URL` — backend Celery для результатов.
- `APP_HOST` и `APP_PORT` — параметры запуска веб-сервера.
- `APP_CONFIG_PATH` — путь до `config.yaml`, если конфиг расположен не в корне контейнера.

### SEO ключевые слова
Domain audit, CMS detection, vulnerability scanning, web security automation, PostgreSQL, Redis, Celery, Docker Compose, WebAtlas, аудит доменов, проверка CMS, безопасность веб-сайтов, TLS сертификаты.
