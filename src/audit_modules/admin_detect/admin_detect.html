{# src/audit_modules/admin_detect/admin_detect.html #}
{% from "partials/_status.html" import status_pill %}

{% set headline = block.headline %}
{% set kpis = block.kpis or {} %}
{% set insights = block.insights or [] %}
{% set timeline = block.timeline or [] %}
{% set hits = block.hits or [] %}
{% set entries = block.entries or [] %}

{# pill: critical если best_http==200 и есть yes hit; warning если есть maybe; ok иначе #}
{% set st = 'ok' %}
{% if kpis.hits_yes|default(0) > 0 and kpis.best_http == 200 %}
  {% set st = 'critical' %}
{% elif (kpis.hits_yes|default(0) > 0) or (kpis.hits_maybe|default(0) > 0) %}
  {% set st = 'warning' %}
{% endif %}

<div class="card-header">
  <div>
    <p class="card-title">{{ block.name }}</p>
    <p class="card-subtitle">{{ block.description }}</p>
  </div>

  {{ status_pill(st) }}
</div>

<div class="card-body stack">

  {# === HEADLINE === #}
  {% if headline %}
    <div class="card" style="margin:0; background:color-mix(in oklab, var(--surface), var(--surface-2) 25%);">
      <div class="card-body" style="padding:14px;">
        <p style="margin:0; font-size:16px; font-weight:700;">
          {{ headline }}
        </p>
        <p class="hint" style="margin-top:6px;">
          Это инвентаризация входов (пути + контентные сигнатуры). Не проверка уязвимостей.
        </p>
      </div>
    </div>
  {% endif %}

  {# === KPIs === #}
  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:10px;">
    {% if kpis.checked_count is not none %}
      <div class="card">
        <div class="card-body">
          <p class="hint">Проверено путей</p>
          <p style="font-size:18px; font-weight:700;">{{ kpis.checked_count }}</p>
        </div>
      </div>
    {% endif %}
    {% if kpis.hits_yes is not none %}
      <div class="card">
        <div class="card-body">
          <p class="hint">Найдено (yes)</p>
          <p style="font-size:18px; font-weight:700;">{{ kpis.hits_yes }}</p>
        </div>
      </div>
    {% endif %}
    {% if kpis.hits_maybe is not none %}
      <div class="card">
        <div class="card-body">
          <p class="hint">Найдено (maybe)</p>
          <p style="font-size:18px; font-weight:700;">{{ kpis.hits_maybe }}</p>
        </div>
      </div>
    {% endif %}
    {% if kpis.best_path %}
      <div class="card">
        <div class="card-body">
          <p class="hint">Лучшее совпадение</p>
          <p class="mono" style="font-size:12px; margin:0;">{{ kpis.best_path }}</p>
          {% if kpis.best_label %}
            <p class="hint" style="margin-top:6px;">{{ kpis.best_label }}</p>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  {# === HITS (top) === #}
  {% if hits %}
    <div class="card" style="margin:0;">
      <div class="card-header">
        <p class="card-title">Найденные входы (топ)</p>
      </div>
      <div class="card-body">
        <div class="stack" style="gap:10px;">
          {% for h in hits %}
            {% set hst = 'ok' if h.bucket == 'restricted' else 'critical' if (h.bucket == 'accessible' and h.status == 'yes') else 'warning' %}
            <div class="card" style="margin:0;">
              <div class="card-body" style="padding:12px;">
                <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
                  <div>
                    <div style="font-weight:700;">
                      {{ h.label }} <span class="hint">({{ h.panel_key }})</span>
                    </div>
                    <div class="hint">
                      путь: <span class="mono">{{ h.path }}</span> ·
                      HTTP: <span class="mono">{{ h.http_status }}</span> ·
                      тип: <span class="mono">{{ h.bucket }}</span> ·
                      score: <span class="mono">{{ h.score }}</span> ·
                      verdict: <span class="mono">{{ h.status }}</span>
                    </div>
                    {% if h.final_url %}
                      <div class="hint" style="margin-top:6px;">
                        итоговый URL: <span class="mono">{{ h.final_url }}</span>
                      </div>
                    {% endif %}
                  </div>
                  {{ status_pill(hst) }}
                </div>

                {% if h.evidence and h.evidence.signals %}
                  <div style="margin-top:10px;">
                    <p class="hint" style="margin:0 0 6px 0;">Сигналы</p>
                    <ul style="margin:0; padding-left:18px;">
                      {% for s in h.evidence.signals %}
                        <li style="margin:4px 0;">
                          <span class="mono">{{ s.type }}</span> · <code>{{ s.value }}</code>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}

  {# === INSIGHTS === #}
  {% if insights %}
    <div class="card" style="margin:0;">
      <div class="card-body">
        <p class="hint" style="margin-bottom:6px;">Выводы</p>
        <ul style="margin:0; padding-left:18px;">
          {% for i in insights %}
            <li style="margin:4px 0;">{{ i }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endif %}

  {# === TIMELINE === #}
  {% if timeline %}
    <div class="card" style="margin:0;">
      <div class="card-header">
        <p class="card-title">Последние запуски</p>
      </div>
      <div class="card-body">
        <div class="stack">
          {% for t in timeline %}
            <div style="display:flex; gap:10px; align-items:flex-start;">
              <span class="mono">{{ t.timestamp }}</span>
              <div>
                <div>{{ t.title }}</div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}

  {# === LAST CHECKS (legacy) === #}
  {% if entries %}
    <details class="card" style="margin:0;">
      <summary class="card-header" style="cursor:pointer;">
        <p class="card-title" style="margin:0;">Последние проверки (детали)</p>
      </summary>
      <div class="card-body">
        <div class="stack">
          {% for e in entries %}
            <div style="display:flex; gap:10px; align-items:flex-start;">
              <span class="mono">{{ e.timestamp }}</span>
              <div>
                <div>{{ e.message }}</div>
                {% if e.details and e.details.final_url %}
                  <div class="hint">итоговый URL: <span class="mono">{{ e.details.final_url }}</span></div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </details>
  {% endif %}

</div>
